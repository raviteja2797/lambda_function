import json
import os
import boto3
import datetime

start_date = str(datetime.datetime.now().strftime("%Y%m%d-%H%M%S"))
region = os.getenv("region")
cli = boto3.client('ec2',region_name=region)
instanceids = ['instanceid']

def lambda_handler(event, context):
    if os.getenv('instances') == 'backup':
        
        reservations = cli.describe_instances( Filters=[{ 'Name': 'tag-key', 'Values': ['backup',]},], DryRun=False).get('Reservations', [])
        instances = sum([[i for i in r['Instances']]for r in reservations], [])
        for instance in instances:
            instanceids.append(instance['InstanceId'])
    
    for instanceid in instanceids:
        name= "Lambda for "+instanceid+" from "+start_date
        description= "AMI for "+instanceid+" created by lambda"
        image = cli.create_image(Description=description,DryRun=False, InstanceId=instanceid, Name=name, NoReboot=True)
        print(image['ImageId'])
